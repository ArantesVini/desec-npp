
# Introducao a Redes TCP/IP

Rede - Comunicacao entre dois ou **mais** computadores

Host - Nome atribuido a um computador na rede
Servidor - Fornece algum servico a rede
Cliente - Consome algum servico oferecido por um servidor

## Protocolos

Garantem que diferentes hardwares e softwares consigam se comunicar, um exemplo de protocolo é o TCP/IP.
A comunicao só existe por conta do protocolo que ambos os lados compreendem.

## Enderecos Físicos e Lógicos e Portas


### Fisico
- Endereco Fisico é o **MAC Address** e vem definido de fábrica (apesar de ser facilmente trocado).
- É uma sequencia de 6 bytes, onde os 3 primeiros sao referente ao fabricante e os 3 ultimos uma sequencia unica,
- Exemplo **A4:5E:60:B8:C1:AF**  - A4:5E:60 Referente ao fabricante e B8:C1:AF a sequencia unica.


### Lógico
- Endereco lógico (**IP**) é atribuido ao adaptador de rede de acordo com a rede, pode se configurado manualmente ou automaticamnete (DHCP)
- Formado por 4 octetos representados de forma decimal, como **192.168.0.200**
- Existem IP privados (rede interna) e IP Público (rede externa)


### Portas
- Cada servico ativo usa uma porta de identificacao
- Vao de 0 a 65.535 e normalmente utilizadas com os protocolos TCP ou UDP
- Existem número que sao o padrao para alguns servicos especifcos (*mas nao obrigatorios*)
- 80 para HTTP, 443 para HTTPS, 25 para SMTP, 161 para SNMP, 23 para TELNET, 21 para FTP, 22 para SSH ,entre outras.
- **SOCKET** é referente a um conjunto de *IP:Porta*
## Roteamento

Redes diferentes só se enxergam através do roteamento de rede, para isso precisam definir um gateway.

# Protocolos de Redes

Sao compostos por duas partes:
- **HEADER** - Cabecalho com uma estrutura específica
- **PAYLOAD** - Área de dados com informacoes que o protocolo carrega

Uma simples comunicao Cliente -> Servidor necessita de diversos protocolos para funcionar.
## Modelos de Referencia

Criados para serem utilizados como uma referencia aos desenvolvedores e fabricantes para criarem produtos compativeis entre si, exemplo:
- **OSI** (*Open Systems Interconnection*) - Modelo conceitual composto por 7 camadas
- **TCP/IP** - Simplificacao do modelo OSI, composto por 4 camadas

## Encapsulamento

Encapsulamento é incluir um protocolo em outro protocolo através do Payload, exemplo que um frame **ethernet** contem um pacote IP que contem um segmento TCP que contem os dados do protocolo HTTP
Protocolo HTTP
**HEADER TCP** - Payload Tcp
**HEADER IP** - Payload IP
**HEADER Ethernet** - Payload Ethernet

# Protocolo Ethhernet

- Entende apenas **enderecos fisicos**
- Estrutura: Mac de destino, mac de origem, tipo do protocolo, payload e checksum

# Protocolo ARP

- Descobrir qual endereco **MAC** esta associado a qual **IP**
- Utiliza **ARP Request** e **ARP Reply**
- **ARP Request** pergunta a um IP (em toda a rede) qual seu MAC
- **ARP Reply** o host que tem o IP requisitado responde com seu MAC
- O Host que recebe a resposta armazena o IP e MAC por um tempo
- Estrutura tem 4 bytes de largura (Nao cabe o endereco MAC completo por exemplo, entao usa mais de um campo para armazenar algum dado)![[estrutura.png]]
![[estrutura_nomes.png]]


# Protocolo IP

- Realiza a entrega dos pacotes entre maquinas
- Nao é confiavel, apenas entrega o pacote sem realizar nenhuma verificacao
- Se quiseremos confiabilidade, associamos ao **TCP**
- Se quisermos velocidade, associamos ao **UDP**
- Apesar de suportar mais de 65 mil bytes, como geralmente esta no payload de um protocolo Ethernet, fica limitado a 1500 bytes
- Por conta dessa limitacao, o **fracionamento** de pacotes é muito importante para o protocolo
## Fragmentacao de Pacotes IP

- Quando o pacote for fragmentado, o header do Pacote IP terá uma identificacao (*Identification*) e marcando a flag *More fragments*, indicando que houve a fragmentacao
- A sequencia dos pacotes é definida pelo campo *Fragment offset*
- O último fragmento do pacote nao ira marcar a flag *More Fragments*


# Protocolo TCP

- É um protocolo confiável, que garante a entrega das informacoes
- Orientado a conexao - So transmite se garantir que a conexao foi estabelecida com sucesso (*Three-way Handshake*)
- Se comunica com **portas**
- Utiliza **flags** para realizar as validacoes

**SYN** - Sincronizar, conexao entre os lados envolvidos
**FIN** - Conexao deve ser fechada
**RST** - Houve erro na comunicacao, resetar
**PSH** - Existem dados no paylaod TCP
**ACK** - Comunicacao realizada, sabe o proximo número da sequencia
**URG** - Urgente, counteudo deve ser priorizado

# 3WHS - Three-way Handshake

- É a conexao inicial que garante que a comunicao foi estabelecida entre cliente e servidor
- Ocorre com **SYN** para o servidor -> **SYN/ACK** para o cliente-> **ACK** para o servidor 


# Entendendo o DNS

- O DNS é o que nos permite acessar Websites através de uma **URL** e nao do endereco IP do servidor
- É realizada uma consulta **UDP/IP** para o DNS configurado, buscando qual o endereco logico do site que digitamos
- O retorno do servidor DNS é o **endereco IP** da URL enviada

# Protocolo HTTP

- Funciona através das trocas de requisicoes entre **cliente** e **servidor**
- Composta por um **header** e um **body**
- Suporta diferente métodos, como *GET*, *POST*, *HEAD*, *PUT*, *DELETE*, *OPTIONS*
- Funciona por **Requests** e **Responses**
- GET / HTTP/1.1 - Exemplo de Request GET para o diretório raiz de um servidor. A Response do servidor será um **Código de Resposta** 

# Protocolo ICMP

- Alerta por mensagens, emite avisos sobre a situacao da rede
- Estrutura simples composta por tipos e códigos
- Muito importante para envios de pacote UDP, onde atua avisando que uma porta/host/rede nao existe
- Usado no **ping** , muito utilizado em qualquer processo de *pentest*
![[Pasted image 20231123070440.png]]


# Time to Live - TTL

- **Tempo de vida **de um pacote IP
- Cada vez que o TTL passa por um roteador (processo chamado de *hop*) o TTL é decrementado em 1, até se tornar 0, quando o valor se torna 0 o roteador descarta o pacote
- Existem padroes de TTL em diferentes OS: 
	- Windows - 128
	- Linux - 64
	- Unix - 255
- Esse valor pode ser alterado em qualquer OS, mas geralmente é um bom indicador


# Traceroute com ICMP

- Quando o TTL de um pacote se torna 0, o roteador utiliza o protocolo ICMP para avisar, usando um ICMP de **tipo 11** e **código 0**
- Dessa forma, podemos manipular o TTL para descobrir o **caminho** e a **rota** que o pacote percorre
- No linux existe o comando `traceroute {url}` que realiza essa rota completa

# Bytes na rede

- Frames, pacotes, segmentos e payloads sao apenas Bytes trafegando na rede
- Os primeiros 6 bytes sao o MAC de destino, seguido do MAC de origem e nos proximos 2 bytes, o protocolo (Exemplo de um Frame Ethernet)
![[Pasted image 20231123185907.png]]
- Na sequencia teremos o payload
- Os analisadores de rede, como *wireshark* utiliza esses bytes para entregar a informacao

## Bytes na rede - Protocolo IP

- Com um IP carregado no Payload de um Frame Ethernet, seu **header** se inicia após 16 bytes
- Sabendo o tamanho de um Header IP, basta incrementar esse tamanho para definir o inicio do Payload
- Os valores sao hexadecimais, entao para saber o decimal, precisamos converter usando por exemplo `print "%d\n" 0x{hex}` no linux